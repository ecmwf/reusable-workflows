# This workflow runs pre-commit checks and pytest tests against multiple platforms and Python versions.
name: Code Quality and Testing

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
  schedule:
    - cron: "9 2 * * 0" # at 9:02 on sunday
  merge_group:

jobs:
  quality:
    uses: ecmwf/reusable-workflows/.github/workflows/qa-precommit-run.yml@v2
    with:
      skip-hooks: "no-commit-to-branch"

  checks:
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    uses: ecmwf/reusable-workflows/.github/workflows/qa-pytest-pyproject.yml@v2
    with:
      python-version: {% raw %}${{ matrix.python-version }}{% endraw %}

  all-checks-passed:
    name: All checks passed
    if: always()
    needs: [quality, checks]
    runs-on: ubuntu-latest

    steps:
      - name: Check all job statuses
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;

            // Check quality and pytest jobs
            const qualityResult = '${{ needs.quality.result }}';
            const checksResult = '${{ needs.checks.result }}';

            core.info(`Quality job status: ${qualityResult}`);
            core.info(`Checks job status: ${checksResult}`);

            if (qualityResult !== 'success') {
              core.setFailed('Quality job did not succeed');
              return;
            }

            if (checksResult !== 'success') {
              core.setFailed('Checks job did not succeed');
              return;
            }
