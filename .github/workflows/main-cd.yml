name: Reusable CD Pipeline

on:
  workflow_call:
    inputs:
      config_file:
        description: 'Path to build configuration file'
        required: false
        type: string
        default: '.github/cd-config.yml'
      ref_name:
        description: 'Git ref name for artifacts and release'
        required: true
        type: string
      dry_run:
        description: 'Dry run mode - build only, no uploads or releases'
        required: false
        type: boolean
        default: false

jobs:
  detect-release-type:
    name: Detect Release Type
    runs-on: ubuntu-latest
    outputs:
      is_dry_run: ${{ steps.detect.outputs.is_dry_run }}
      is_prerelease: ${{ steps.detect.outputs.is_prerelease }}
    steps:
      - name: Detect release type from ref
        id: detect
        shell: python3 {0}
        run: |
          import re
          import os

          ref_name = "${{ inputs.ref_name }}"
          deployment_regex = r"${{ vars.TAG_REGEX_FOR_DEPLOYMENT }}"
          prerelease_regex = r"${{ vars.TAG_REGEX_FOR_PRERELEASE }}"
          dry_run_input = "${{ inputs.dry_run }}"

          print(f"Analyzing ref: {ref_name}")

          # Check if it's a standard semantic version tag (e.g., v1.2.3 or 1.2.3)
          if re.match(deployment_regex, ref_name):
              print("Standard release detected")
              is_dry_run = "false"
              is_prerelease = "false"

          # Check if it's a pre-release tag (e.g., v1.2.3-RC1, 1.2.3-alpha1)
          elif re.match(prerelease_regex, ref_name):
              print("Pre-release detected")
              is_dry_run = "false"
              is_prerelease = "true"

          # Everything else is a dry run (PRs, branches, etc.)
          else:
              print("Dry run detected")
              is_dry_run = "true"
              is_prerelease = "false"

          # Override with explicit dry_run input if provided
          if dry_run_input == "true":
              print("Explicit dry_run input enabled - forcing dry run mode")
              is_dry_run = "true"

          # Write outputs
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"is_dry_run={is_dry_run}\n")
              f.write(f"is_prerelease={is_prerelease}\n")

  load-config:
    name: Load and Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      config: ${{ steps.load.outputs.config }}
      build_matrix: ${{ steps.generate-matrix.outputs.matrix }}
      release_enabled: ${{ steps.parse-release.outputs.enabled }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Check configuration file exists
        id: check-config
        run: |
          if [[ ! -f "${{ inputs.config_file }}" ]]; then
            echo "Configuration file ${{ inputs.config_file }} not found"
            echo "Looking for alternative locations..."
            if [[ -f ".github/workflows/cd-config.yml" ]]; then
              echo "config_file=.github/workflows/cd-config.yml" >> $GITHUB_OUTPUT
            else
              echo "No configuration file found. Please create ${{ inputs.config_file }}"
              exit 1
            fi
          else
            echo "config_file=${{ inputs.config_file }}" >> $GITHUB_OUTPUT
          fi

      - name: Load configuration
        id: load
        run: |
          config=$(cat "${{ steps.check-config.outputs.config_file }}")
          echo "Raw configuration loaded"
          # Validate YAML syntax
          echo "$config" | yq > /dev/null
          echo "config<<EOF" >> $GITHUB_OUTPUT
          echo "$config" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate build matrix
        id: generate-matrix
        shell: python3 {0}
        run: |
          import yaml, json, os

          config_yaml = '''${{ steps.load.outputs.config }}'''
          config = yaml.safe_load(config_yaml)

          matrix = {'include': []}

          for build in config.get('builds', []):
              if build.get('enabled', True):
                  build_config = build.get('config', {})
                  build_type = build['type']

                  if build_type == 'conda':
                      matrix_item = {
                          'name': build['name'],
                          'runner': ['self-hosted', 'platform-builder'],
                          'type': build_type,
                          'container': '',
                          'conda_dir': build_config.get('conda_dir', './.cd/.conda'),
                      }
                      # Convert channels list to comma-separated string
                      channels = build_config.get('channels', ['conda-forge'])
                      if isinstance(channels, list):
                          matrix_item['channels'] = ','.join(channels)
                      else:
                          matrix_item['channels'] = str(channels)
                      matrix_item['conda_build_args'] = build_config.get('conda_build_args', '--no-anaconda-upload')
                      matrix['include'].append(matrix_item)

                  elif build_type == 'python-pypi':
                      matrix_item = {
                          'name': build['name'],
                          'runner': ['self-hosted', 'platform-builder'],
                          'type': build_type,
                          'container': '',
                          'working_directory': build_config.get('working_directory', './'),
                          'buildargs': build_config.get('buildargs', ''),
                          # Keep env_vars as JSON string
                          'env_vars': json.dumps(build_config.get('env_vars', {})),
                      }
                      matrix['include'].append(matrix_item)

                  elif build_type == 'system-package':
                      default_platforms = {
                          'ubuntu-2204': {
                              'runner': ['self-hosted', 'platform-builder-docker-xl'],
                              'os': 'ubuntu-2204',
                              'nexus_token_secret': 'NEXUS_TEST_REPO_UPLOAD_TOKEN',
                              'nexus_url_secret': 'NEXUS_TEST_REPO_URL_UBUNTU_2204',
                          },
                          'ubuntu-2404': {
                              'runner': ['self-hosted', 'platform-builder-docker-xl'],
                              'os': 'ubuntu-2404',
                              'nexus_token_secret': 'NEXUS_TEST_REPO_UPLOAD_TOKEN',
                              'nexus_url_secret': 'NEXUS_TEST_REPO_URL_UBUNTU_2404',
                          },
                          'debian-11': {
                              'runner': ['self-hosted', 'platform-builder-docker-xl'],
                              'os': 'debian-11',
                              'nexus_token_secret': 'NEXUS_TEST_REPO_UPLOAD_TOKEN',
                              'nexus_url_secret': 'NEXUS_TEST_REPO_URL_DEBIAN_11',
                          },
                          'debian-12': {
                              'runner': ['self-hosted', 'platform-builder-docker-xl'],
                              'os': 'debian-12',
                              'nexus_token_secret': 'NEXUS_TEST_REPO_UPLOAD_TOKEN',
                              'nexus_url_secret': 'NEXUS_TEST_REPO_URL_DEBIAN_12',
                          },
                          'debian-13': {
                              'runner': ['self-hosted', 'platform-builder-docker-xl'],
                              'os': 'debian-13',
                              'nexus_token_secret': 'NEXUS_TEST_REPO_UPLOAD_TOKEN',
                              'nexus_url_secret': 'NEXUS_TEST_REPO_URL_DEBIAN_13',
                          },
                          'rocky-8': {
                              'runner': ['self-hosted', 'platform-builder-docker-xl'],
                              'os': 'rocky-8',
                              'nexus_token_secret': 'NEXUS_TEST_REPO_UPLOAD_TOKEN',
                              'nexus_url_secret': 'NEXUS_TEST_REPO_URL_ROCKY_8',
                          },
                          'rocky-9': {
                              'runner': ['self-hosted', 'platform-builder-docker-xl'],
                              'os': 'rocky-9',
                              'nexus_token_secret': 'NEXUS_TEST_REPO_UPLOAD_TOKEN',
                              'nexus_url_secret': 'NEXUS_TEST_REPO_URL_ROCKY_9',
                          },
                          'rocky-10': {
                              'runner': ['self-hosted', 'platform-builder-docker-xl'],
                              'os': 'rocky-10',
                              'nexus_token_secret': 'NEXUS_TEST_REPO_UPLOAD_TOKEN',
                              'nexus_url_secret': 'NEXUS_TEST_REPO_URL_ROCKY_10',
                          },
                          'fedora-43': {
                              'runner': ['self-hosted', 'platform-builder-docker-xl'],
                              'os': 'fedora-43',
                              'nexus_token_secret': 'NEXUS_TEST_REPO_UPLOAD_TOKEN',
                              'nexus_url_secret': 'NEXUS_TEST_REPO_URL_FEDORA_43',
                          },
                      }

                      platform_name = build_config.get('os', '')
                      if platform_name not in default_platforms:
                          print(f"::error::Unknown platform: {platform_name}")
                          raise SystemExit(1)

                      defaults = default_platforms[platform_name]
                      skip_version_check = str(build_config.get('skip_version_check', False)).lower()
                      raw_deps = build_config.get('package_deps', [])
                      if isinstance(raw_deps, list):
                          package_deps = ', '.join(raw_deps)
                      else:
                          package_deps = str(raw_deps)

                      container = {
                          'image': f'diazard/platform-builder:{defaults["os"]}',
                          'options': '--user root',
                          'volumes': ['/var/run/docker.sock:/var/run/docker.sock'],
                      }

                      if '${{ secrets.DOCKERHUB_USERNAME }}' and '${{ secrets.DOCKERHUB_TOKEN }}':
                          container['credentials'] = {
                              'username': '${{ secrets.DOCKERHUB_USERNAME }}',
                              'password': '${{ secrets.DOCKERHUB_TOKEN }}'
                          }

                      platform_item = {
                          'name': build['name'],
                          'runner': defaults['runner'],
                          'type': 'system-package',
                          'container': json.dumps(container),
                          'os': defaults['os'],
                          'skip_version_check': skip_version_check,
                          'package_deps': package_deps,
                          'description': build_config.get('description', ''),
                          'license': build_config.get('license', ''),
                          'maintainer': build_config.get('maintainer', 'software@ecmwf.int'),
                          'vendor': build_config.get('vendor', 'ECMWF'),
                          'homepage_url': build_config.get('homepage_url', ''),
                          'install_prefix': build_config.get('install_prefix', '/opt/ecmwf'),
                          'self_test': str(build_config.get('self_test', False)).lower(),
                          'install_test': str(build_config.get('install_test', False)).lower(),
                          'install_test_os_image': build_config.get('install_test_os_image', ''),
                          'install_test_command': build_config.get('install_test_command', ''),
                          'build_type': build_config.get('build_type', 'RelWithDebInfo'),
                          'env': build_config.get('env', ''),
                          'deb_section': build_config.get('deb_section', ''),
                          'deb_priority': build_config.get('deb_priority', 'optional'),
                          'rpm_group': build_config.get('rpm_group', ''),
                          'dependencies': build_config.get('dependencies', ''),
                          'dependency_branch': build_config.get('dependency_branch', ''),
                          'cmake_options': build_config.get('cmake_options', ''),
                          'ctest_options': build_config.get('ctest_options', ''),
                          'dependency_cmake_options': build_config.get('dependency_cmake_options', ''),
                          'cmake': str(build_config.get('cmake', False)).lower(),
                          'ecbundle': str(build_config.get('ecbundle', False)).lower(),
                          'self_build': str(build_config.get('self_build', True)).lower(),
                          'toolchain_file': build_config.get('toolchain_file', ''),
                          'parallelism_factor': str(build_config.get('parallelism_factor', '2')),
                          'compiler_cc': build_config.get('compiler_cc', 'gcc'),
                          'compiler_cxx': build_config.get('compiler_cxx', 'g++'),
                          'compiler_fc': build_config.get('compiler_fc', 'gfortran'),
                          'nexus_token_secret': defaults['nexus_token_secret'],
                          'nexus_url_secret': defaults['nexus_url_secret'],
                      }
                      matrix['include'].append(platform_item)

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"matrix={json.dumps(matrix)}\n")

      - name: Parse release configuration
        id: parse-release
        run: |
          enabled=$(echo '${{ steps.load.outputs.config }}' | yq '.release.enabled // false')
          echo "enabled=$enabled" >> $GITHUB_OUTPUT

  build:
    name: ${{ matrix.name }}
    if: ${{ fromJson(needs.load-config.outputs.build_matrix).include[0] != null }}
    needs: [detect-release-type, load-config]
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container && fromJson(matrix.container) || '' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.load-config.outputs.build_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: ${{ startsWith(github.ref, 'refs/tags/') && '1' || '50' }}
          fetch-tags: ${{ !startsWith(github.ref, 'refs/tags/') }}

      - name: Build with Conda
        if: ${{ matrix.type == 'conda' }}
        uses: ecmwf/reusable-workflows/cd-actions/conda@v2
        with:
          name: ${{ matrix.name }}
          ref_name: ${{ inputs.ref_name }}
          dry_run: ${{ needs.detect-release-type.outputs.is_dry_run }}
          test_nexus: 'true'
          gh_pat: ${{ secrets.GH_REPO_READ_TOKEN }}
          nexus_token: ${{ secrets.NEXUS_CONDA_UPLOAD_USER && secrets.NEXUS_CONDA_UPLOAD_TOKEN && format('{0}:{1}', secrets.NEXUS_CONDA_UPLOAD_USER, secrets.NEXUS_CONDA_UPLOAD_TOKEN) || '' }}
          nexus_test_token: ${{ secrets.NEXUS_TEST_CONDA_UPLOAD_USER && secrets.NEXUS_TEST_CONDA_UPLOAD_TOKEN && format('{0}:{1}', secrets.NEXUS_TEST_CONDA_UPLOAD_USER, secrets.NEXUS_TEST_CONDA_UPLOAD_TOKEN) || '' }}
          conda_dir: ${{ matrix.conda_dir }}
          channels: ${{ matrix.channels }}
          conda_build_args: ${{ matrix.conda_build_args }}

      - name: Build with Python PyPI
        if: ${{ matrix.type == 'python-pypi' }}
        uses: ecmwf/reusable-workflows/cd-actions/python-pypi@v2
        with:
          name: ${{ matrix.name }}
          ref_name: ${{ inputs.ref_name }}
          dry_run: ${{ needs.detect-release-type.outputs.is_dry_run }}
          pypi_token: ${{ secrets.PYPI_API_TOKEN }}
          pypi_test_token: ${{ secrets.PYPI_TEST_API_TOKEN }}
          working_directory: ${{ matrix.working_directory }}
          buildargs: ${{ matrix.buildargs }}
          env_vars: ${{ matrix.env_vars }}
          testpypi: ${{ needs.detect-release-type.outputs.is_prerelease }}

      - name: Build System Package
        if: ${{ matrix.type == 'system-package' }}
        uses: ecmwf/reusable-workflows/cd-actions/system-package@cd-sp-docker
        with:
          name: ${{ matrix.name }}
          ref_name: ${{ inputs.ref_name }}
          dry_run: ${{ needs.detect-release-type.outputs.is_dry_run }}
          skip_version_check: ${{ matrix.skip_version_check }}
          package_deps: ${{ matrix.package_deps }}
          description: ${{ matrix.description }}
          license: ${{ matrix.license }}
          maintainer: ${{ matrix.maintainer }}
          vendor: ${{ matrix.vendor }}
          homepage_url: ${{ matrix.homepage_url }}
          install_prefix: ${{ matrix.install_prefix }}
          self_test: ${{ matrix.self_test }}
          install_test: ${{ matrix.install_test }}
          install_test_os_image: ${{ matrix.install_test_os_image }}
          install_test_command: ${{ matrix.install_test_command }}
          build_type: ${{ matrix.build_type }}
          env: ${{ matrix.env }}
          deb_section: ${{ matrix.deb_section }}
          deb_priority: ${{ matrix.deb_priority }}
          rpm_group: ${{ matrix.rpm_group }}
          os: ${{ matrix.os }}
          dependencies: ${{ matrix.dependencies }}
          dependency_branch: ${{ matrix.dependency_branch }}
          cmake_options: ${{ matrix.cmake_options }}
          ctest_options: ${{ matrix.ctest_options }}
          dependency_cmake_options: ${{ matrix.dependency_cmake_options }}
          cmake: ${{ matrix.cmake }}
          ecbundle: ${{ matrix.ecbundle }}
          self_build: ${{ matrix.self_build }}
          toolchain_file: ${{ matrix.toolchain_file }}
          parallelism_factor: ${{ matrix.parallelism_factor }}
          compiler_cc: ${{ matrix.compiler_cc }}
          compiler_cxx: ${{ matrix.compiler_cxx }}
          compiler_fc: ${{ matrix.compiler_fc }}
          gh_pat: ${{ secrets.GH_REPO_READ_TOKEN }}
          nexus_token: ${{ secrets[matrix.nexus_token_secret] }}
          nexus_url: ${{ secrets[matrix.nexus_url_secret] }}

  release:
    name: Create Release
    if: ${{ needs.load-config.outputs.release_enabled == 'true' && needs.detect-release-type.outputs.is_dry_run == 'false' && needs.build.result == 'success' }}
    needs: [detect-release-type, load-config, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Prepare release configuration
        id: prepare-config
        run: |
          config='${{ needs.load-config.outputs.config }}'
          is_prerelease='${{ needs.detect-release-type.outputs.is_prerelease }}'

          # Inject prerelease flag into config
          updated_config=$(echo "$config" | yq eval ".release.config.prerelease = ($is_prerelease == \"true\")" -)

          echo "config<<EOF" >> $GITHUB_OUTPUT
          echo "$updated_config" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub release
        uses: ecmwf/reusable-workflows/cd-actions/release@v2
        with:
          config: ${{ steps.prepare-config.outputs.config }}
          ref_name: ${{ inputs.ref_name }}
