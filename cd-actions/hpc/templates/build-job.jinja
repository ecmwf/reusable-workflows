{% from 'macros.jinja' import start_group, end_group, cmake_package, python_package, post_script, job_footer, setup_ecbundle, git_fetch, set_package_version, load_modules, set_env, ecbundle_workflow with context %}

{# Build in work directory #}
cd {{ ci_options.workdir }}

{# === Build Log Setup === #}
BUILD_LOG="{{ ci_options.install_prefix }}/build.log"
chmod -R u+w "{{ ci_options.base_install_prefix }}" 2>/dev/null || chmod -R u+w "{{ ci_options.install_prefix }}" 2>/dev/null || true
mkdir -p "{{ ci_options.install_prefix }}"
: > "$BUILD_LOG"
exec > >(tee "$BUILD_LOG") 2>&1
echo "Build started: $(date -u)"
echo "Build name: {{ ci_options.build_name }}"
echo "Repository: {{ ci_options.main_package_name }}"

{# Make requested directories #}
{% if ci_options.mkdir %}
{% for dir in ci_options.mkdir %}
mkdir -p {{ ci_options.workdir }}/{{ dir }}
{% endfor %}
{% endif %}

{# === Build with ecbundle === #}
{% if ci_options.use_ecbundle %}
{% set ecbundle_pkg = packages|selectattr('type', 'equalto', 'ecbundle')|first %}
{{ load_modules(generic_modules, ecbundle_pkg.modules if ecbundle_pkg else []) }}
{{ set_env(env) }}

{% for package in packages if package.type == "ecbundle" %}
{{ ecbundle_workflow(package=package) }}
{% endfor %}

{% else %}
{# === Standard build path (dependencies + main + python) === #}

{# === Build dependencies (with caching) === #}
{% for package in packages if package.type == "dependency" %}
{% if package.name == "ecbundle" and ci_options.ecbundle %}
{{ setup_ecbundle(package=package) }}
{% else %}
{{ cmake_package(package=package) }}
{% endif %}
{% endfor %}

{# === Build main package === #}
{% for package in packages if package.type == "main" %}
{% if stages %}
{# --- Staged build: multiple configure/build/install cycles --- #}
{{ load_modules(generic_modules, package.modules) }}
{{ set_env(env) }}

{{ git_fetch(package) }}
{{ set_package_version(package=package) }}

cd {{ ci_options.workdir }}/{{ package.name }}
mkdir -p build && cd build

INSTALL_PREFIX="{{ ci_options.install_prefix }}"
export INSTALL_PREFIX

{% if ci_options.clean_before_install %}
{{ start_group("Cleaning before install: " + package.name) }}
if cd {{ package.prefix }} 2>/dev/null; then
  echo "Removing the previous install: {{ package.prefix }}"
  find . -type f -or -type d -exec chmod u+w {} \;
  rm -rfv ./*
  cd -
else
  echo "Nothing to clean up."
fi
{{ end_group() }}
{% endif %}

{% for stage in stages %}
{{ start_group("Stage: " + stage.name) }}

{# Load stage-specific modules #}
{% for mod in stage.modules %}
module load {{ mod }}
{% endfor %}

echo "::STAGE_MARKER::{{ stage.name }}"

{# Configure if first stage or stage has custom cmake_options #}
{% if loop.index0 == 0 or stage.cmake_options %}
{% if loop.index0 > 0 %}
cd {{ ci_options.workdir }}/{{ package.name }}
rm -rf build && mkdir build && cd build
{% endif %}
ecbuild --prefix={{ package.prefix }} .. {% if "ninja" in generic_modules %}-GNinja{% endif %} -DINSTALL_LIB_DIR='lib' {{ stage.cmake_options }} {{ package.cmake_options|join(" ") if package.cmake_options else "" }}
{% endif %}

{# Build #}
{% if stage.build_command %}
{{ stage.build_command }}
{% else %}
cd {{ ci_options.workdir }}/{{ package.name }}/build
time cmake --build . -j{{ ci_options.parallel }}
{% endif %}

{# Test #}
{% if stage.test_command %}
echo "Running tests for stage: {{ stage.name }}"
{{ stage.test_command }}
{% endif %}

{# Install #}
{% if stage.install_command %}
{{ stage.install_command }}
{% else %}
cd {{ ci_options.workdir }}/{{ package.name }}/build
time cmake --install . > /dev/null
{% endif %}

{# Unload stage-specific modules #}
{% for mod in stage.modules|reverse %}
module unload {{ mod }}
{% endfor %}

{{ end_group() }}
{% endfor %}

{# Export paths for main package #}
cd {{ ci_options.workdir }}
export {{ package.name|replace("-", "_") }}_DIR="{{ package.prefix }}"
export {{ package.name|upper|replace("-", "_") }}_DIR="{{ package.prefix }}"
export {{ package.name|upper|replace("-", "_") }}_PATH="{{ package.prefix }}"
export PATH="{{ package.prefix }}/bin:$PATH"
export BIN_PATH="{{ package.prefix }}/bin:$BIN_PATH"
export INCLUDE_PATH="{{ package.prefix }}/include:$INCLUDE_PATH"
export INSTALL_PATH="{{ package.prefix }}:$INSTALL_PATH"
export LIB_PATH="{{ package.prefix }}/lib:$LIB_PATH"
export LD_LIBRARY_PATH="{{ package.prefix }}/lib:$LD_LIBRARY_PATH"

{% else %}
{# --- Standard build: single cmake_package call --- #}
{{ cmake_package(package=package) }}
{% endif %}
{% endfor %}

{# === Build Python packages === #}
{% for package in packages if package.type == "main-python" %}
{{ python_package(package=package) }}
{% endfor %}

{% endif %}

{{ post_script() }}

{{ job_footer() }}
