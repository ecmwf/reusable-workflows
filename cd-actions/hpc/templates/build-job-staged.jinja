{% from 'macros.jinja' import start_group, end_group, cmake_package, python_package, post_script, job_footer, setup_ecbundle, git_fetch, set_package_version, load_modules, set_env with context %}

{# Build in work directory #}
cd {{ ci_options.workdir }}

{# === Build Log Setup === #}
BUILD_LOG="{{ ci_options.install_prefix }}/build.log"
mkdir -p "{{ ci_options.install_prefix }}"
: > "$BUILD_LOG"
exec > >(tee "$BUILD_LOG") 2>&1
echo "Build started: $(date -u)"
echo "Repository: {{ ci_options.main_package_name }}"

{# Make requested directories #}
{% if ci_options.mkdir %}
{% for dir in ci_options.mkdir %}
mkdir -p {{ ci_options.workdir }}/{{ dir }}
{% endfor %}
{% endif %}

{# === Build dependencies (with caching) === #}
{% for package in packages if package.type == "dependency" %}
{% if package.name == "ecbundle" and ci_options.ecbundle %}
{{ setup_ecbundle(package=package) }}
{% else %}
{{ cmake_package(package=package) }}
{% endif %}
{% endfor %}

{# === Build main package with stages === #}
{% for package in packages if package.type == "main" %}
{{ git_fetch(package) }}
{{ set_package_version(package=package) }}

cd {{ ci_options.workdir }}/{{ package.name }}
mkdir -p build && cd build

{% for stage in stages %}
{{ start_group("Stage: " + stage.name) }}

{# Load stage-specific modules #}
{% for mod in stage.modules %}
module load {{ mod }}
{% endfor %}

{# Configure if first stage or stage has custom cmake_options #}
{% if loop.index0 == 0 or stage.cmake_options %}
{% if loop.index0 > 0 %}
cd {{ ci_options.workdir }}/{{ package.name }}
rm -rf build && mkdir build && cd build
{% endif %}
ecbuild --prefix={{ package.prefix }} .. {% if "ninja" in generic_modules %}-GNinja{% endif %} -DINSTALL_LIB_DIR='lib' {{ stage.cmake_options }} {{ package.cmake_options|join(" ") if package.cmake_options else "" }}
{% endif %}

{# Build #}
{% if stage.build_command %}
{{ stage.build_command }}
{% else %}
cd {{ ci_options.workdir }}/{{ package.name }}/build
time cmake --build . -j{{ ci_options.parallel }}
{% endif %}

{# Test #}
{% if stage.test_command %}
echo "Running tests for stage: {{ stage.name }}"
{{ stage.test_command }}
{% endif %}

{# Install #}
{% if stage.install_command %}
{{ stage.install_command }}
{% else %}
cd {{ ci_options.workdir }}/{{ package.name }}/build
time cmake --install . > /dev/null
{% endif %}

{# Unload stage-specific modules #}
{% for mod in stage.modules|reverse %}
module unload {{ mod }}
{% endfor %}

{{ end_group() }}
{% endfor %}

{# Export paths for main package #}
cd {{ ci_options.workdir }}
export {{ package.name|replace("-", "_") }}_DIR="{{ package.prefix }}"
export {{ package.name|upper|replace("-", "_") }}_DIR="{{ package.prefix }}"
export {{ package.name|upper|replace("-", "_") }}_PATH="{{ package.prefix }}"
export PATH="{{ package.prefix }}/bin:$PATH"
export BIN_PATH="{{ package.prefix }}/bin:$BIN_PATH"
export INCLUDE_PATH="{{ package.prefix }}/include:$INCLUDE_PATH"
export INSTALL_PATH="{{ package.prefix }}:$INSTALL_PATH"
export LIB_PATH="{{ package.prefix }}/lib:$LIB_PATH"
export LD_LIBRARY_PATH="{{ package.prefix }}/lib:$LD_LIBRARY_PATH"
{% endfor %}

{# === Build Python packages === #}
{% for package in packages if package.type == "main-python" %}
{{ python_package(package=package) }}
{% endfor %}

{{ post_script() }}

{{ job_footer() }}
