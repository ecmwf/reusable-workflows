name: Conda Builder
description: Build conda packages using conda/mamba

inputs:
  name:
    description: 'Build name for artifacts'
    required: true
  ref_name:
    description: 'Git ref name for artifacts'
    required: true
  dry_run:
    description: 'Dry run mode'
    required: false
    default: 'false'
  test_nexus:
    description: 'Use test Nexus repository'
    required: false
    default: 'false'
  gh_pat:
    description: 'GitHub PAT token'
    required: false
  nexus_token:
    description: 'Nexus upload token'
    required: false
  nexus_test_token:
    description: 'Nexus test upload token'
    required: false
  skip_installation_test:
    description: 'Skip testing package installation from Nexus'
    required: false
    default: 'false'
  conda_dir:
    description: 'Directory containing conda recipe (meta.yaml)'
    required: false
    default: './.cd/conda'
  channels:
    description: 'Comma-separated list of conda channels to use (appended to hardcoded internal ECMWF nexus channels)'
    required: false
    default: 'conda-forge'
  conda_build_args:
    description: 'Additional arguments for conda mambabuild command'
    required: false
    default: '--no-anaconda-upload'

runs:
  using: composite
  steps:
    - name: Parse build configuration
      id: config
      shell: bash
      env:
        INPUT_CONDA_DIR: ${{ inputs.conda_dir }}
        INPUT_CHANNELS: ${{ inputs.channels }}
        INPUT_CONDA_BUILD_ARGS: ${{ inputs.conda_build_args }}
        INPUT_TEST_NEXUS: ${{ inputs.test_nexus }}
        INPUT_NEXUS_TOKEN: ${{ inputs.nexus_token }}
        INPUT_NEXUS_TEST_TOKEN: ${{ inputs.nexus_test_token }}
        GITHUB_ACTION_PATH: ${{ github.action_path }}
      run: python3 "${{ github.action_path }}/scripts/parse_config.py"

    - name: Validate configuration files
      id: validate
      shell: bash -el {0}
      run: |
        meta_file="${{ steps.config.outputs.meta_file }}"
        
        if [[ ! -f "$meta_file" ]]; then
            echo "Meta file not found: $meta_file"
            exit 1
        fi
        
        echo "meta_dir=$(dirname $meta_file)" >> $GITHUB_OUTPUT
        echo "Configuration files validated successfully"

    - name: Setup conda env dir
      shell: bash -el {0}
      run: |
        echo "CONDA_ENVS_DIRS=$RUNNER_TEMP/envs" >> "$GITHUB_ENV"
        mkdir -p "$RUNNER_TEMP/envs"

    - name: Create conda environment
      shell: bash -el {0}
      run: |
        BUILD_ENV="build-env-${GITHUB_RUN_ID}"
        echo "BUILD_ENV=$BUILD_ENV" >> "$GITHUB_ENV"
        mamba env create -n "$BUILD_ENV"
          
    - name: Install build dependencies
      shell: bash -el {0}
      run: |
        eval "$(conda shell.bash hook)"
        conda activate "$BUILD_ENV"
        mamba install -y conda conda-build boa conda-verify conda-index
        mamba info
        mamba list
        
    - name: Build conda package
      shell: bash -el {0}
      run: |
        eval "$(conda shell.bash hook)"
        conda activate "$BUILD_ENV"
        meta_dir="${{ steps.validate.outputs.meta_dir }}"
        nexus_url="${{ steps.config.outputs.nexus_url }}"
        channels="${{ steps.config.outputs.channels }}"
        output_folder="${{ steps.config.outputs.output_folder }}"
        build_args="${{ steps.config.outputs.conda_build_args }}"
        if [[ ! $build_args == *"--no-anaconda-upload"* ]]; then
          build_args="${build_args} --no-anaconda-upload"
        fi

        echo "Building conda package from: $meta_dir"
        echo "Output folder: $output_folder"
        echo "Build args: $build_args"

        mkdir -p "$output_folder"

        conda mambabuild "$meta_dir" -c $nexus_url $channels --output-folder "$output_folder" --no-anaconda-upload $build_args
        
    - name: List built packages
      shell: bash -el {0}
      run: |
        output_folder="${{ steps.config.outputs.output_folder }}"
        echo "Built packages:"
        find "$output_folder" -name "*.tar.bz2" -o -name "*.tar.bz2" | sort
        
    - name: Verify artifacts
      shell: bash -el {0}
      run: |
        output_folder="${{ steps.config.outputs.output_folder }}"
        echo "Checking for conda packages in: $output_folder"

        # Check if conda packages exist in output folder
        if ! find "$output_folder" -name "*.tar.bz2" -type f | head -1 | grep -q .; then
            echo "No conda packages found in: $output_folder"
            echo "Available files:"
            find "$output_folder" -type f | head -20
            exit 1
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.run_id }}-${{ inputs.name }}
        path: ${{ steps.config.outputs.artifact_pattern }}
        if-no-files-found: error
        retention-days: 90

    - name: Acquire lock and upload to Nexus
      if: ${{ inputs.dry_run != 'true' }}
      shell: bash -el {0}
      run: |
        nexus_url="${{ steps.config.outputs.nexus_url }}"
        nexus_token="${{ steps.config.outputs.nexus_token }}"
        artifact_name="${{ github.run_id }}-${{ inputs.name }}"

        echo "Acquiring conda index lock and uploading to Nexus: $nexus_url"
        echo "Artifact: $artifact_name"
        echo ""

        # Run the lock acquisition script
        python3 "${{ github.action_path }}/scripts/acquire_lock.py" \
            --nexus-url "$nexus_url" \
            --nexus-token "$nexus_token" \
            --artifact-name "$artifact_name" \
            --caller-run-id "${{ github.run_id }}" \
            --caller-repo "${{ github.repository }}" \
            --gh-pat "${{ inputs.gh_pat }}"

        echo ""
        echo "All packages and indexes uploaded to Nexus successfully!"

    - name: Test package installation from Nexus
      if: ${{ inputs.dry_run != 'true' && inputs.skip_installation_test != 'true' }}
      shell: bash -el {0}
      run: |
        output_folder="${{ steps.config.outputs.output_folder }}"
        nexus_url="${{ steps.config.outputs.nexus_url }}"

        echo "Testing package installation from Nexus..."

        # Get package name and version from built packages
        packages=$(find "$output_folder" -name "*.tar.bz2" -type f)

        for package in $packages; do
            package_name=$(basename "$package")
            echo ""
            echo "Testing installation of: $package_name"

            # Extract package name and version
            pkg_base=$(echo "$package_name" | sed -E 's/-[0-9]+(\.[0-9]+)*-.*//')
            pkg_version=$(echo "$package_name" | sed -E 's/^[^-]+-([0-9]+(\.[0-9]+)*).*/\1/')

            echo "Package: $pkg_base"
            echo "Version: $pkg_version"

            # Create a test environment
            test_env="test-install-${GITHUB_RUN_ID}-${RANDOM}"
            echo "Creating test environment: $test_env"

            eval "$(conda shell.bash hook)"

            # Create environment and install the EXACT version from Nexus
            if mamba create -n "$test_env" -c "$nexus_url" -c conda-forge "${pkg_base}=${pkg_version}" -y; then
                echo "Successfully installed ${pkg_base}=${pkg_version} from Nexus"

                # Verify the exact version is installed
                conda activate "$test_env"
                installed_version=$(conda list "$pkg_base" | grep "$pkg_base" | awk '{print $2}')

                if [ "$installed_version" = "$pkg_version" ]; then
                    echo "Verified exact version: $installed_version matches $pkg_version"
                else
                    echo "Version mismatch: installed $installed_version but expected $pkg_version"
                    conda deactivate
                    conda env remove -n "$test_env" -y
                    exit 1
                fi
                conda deactivate

                # Clean up test environment
                conda env remove -n "$test_env" -y
                echo "Test environment removed"
            else
                echo "Failed to install ${pkg_base}=${pkg_version} from Nexus"
                echo "This could mean the package was not uploaded successfully"
                exit 1
            fi
        done

        echo ""
        echo "All packages successfully installed from Nexus with correct versions!"
