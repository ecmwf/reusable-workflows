name: Python PyPI Publisher
description: Build and publish Python packages to PyPI/TestPyPI using UV

inputs:
  name:
    description: 'Build name for artifacts'
    required: true
  ref_name:
    description: 'Git ref name for release'
    required: true
  dry_run:
    description: 'Dry run mode - build only, no upload'
    required: false
    default: 'false'
  pypi_token:
    description: 'PyPI API token'
    required: false
  pypi_test_token:
    description: 'TestPyPI API token'
    required: false
  working_directory:
    description: 'Working directory for build (for monorepos)'
    required: false
    default: './'
  buildargs:
    description: 'Additional arguments for uv build command'
    required: false
    default: ''
  env_vars:
    description: 'Environment variables as JSON object (e.g., {"KEY": "value"})'
    required: false
    default: '{}'
  testpypi:
    description: 'Publish to TestPyPI instead of PyPI (overrides is_prerelease)'
    required: false
    default: 'false'

runs:
  using: composite
  steps:
    - name: Parse build configuration
      id: config
      shell: python3 {0}
      run: |
        import json
        import os
        import sys

        working_directory = '${{ inputs.working_directory }}'
        buildargs = '${{ inputs.buildargs }}'
        env_vars_json = '''${{ inputs.env_vars }}'''.strip()

        # Parse env_vars JSON
        try:
            env_vars = json.loads(env_vars_json) if env_vars_json else {}
        except json.JSONDecodeError as e:
            print(f"Failed to parse env_vars JSON: {e}")
            sys.exit(1)

        testpypi_input = '${{ inputs.testpypi }}'
        testpypi = testpypi_input == 'true'

        with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as f:
            f.write(f"working_directory={working_directory}\n")
            f.write(f"buildargs={buildargs}\n")
            f.write(f"testpypi={str(testpypi).lower()}\n")

            # Handle env_vars as multiline output
            if env_vars:
                f.write("env_vars<<EOF\n")
                for key, value in env_vars.items():
                    f.write(f"{key}={value}\n")
                f.write("EOF\n")

        print(f"Working directory: {working_directory}")
        print(f"Build args: {buildargs}")
        print(f"Test PyPI: {str(testpypi).lower()}")
        if env_vars:
            print(f"Env vars: {list(env_vars.keys())}")

    - name: Set environment variables from config
      if: steps.config.outputs.env_vars != ''
      shell: bash
      working-directory: ${{ steps.config.outputs.working_directory }}
      run: |
        echo '${{ steps.config.outputs.env_vars }}' >> $GITHUB_ENV

    - name: Build package with uv
      shell: bash
      working-directory: ${{ steps.config.outputs.working_directory }}
      run: |
        echo "Building package with uv..."
        echo "Build args: ${{ steps.config.outputs.buildargs }}"
        uv build ${{ steps.config.outputs.buildargs }}
        echo ""
        echo "Built packages:"
        ls -lh dist/

    - name: Publish to PyPI
      if: ${{ false && inputs.dry_run != 'true' && steps.config.outputs.testpypi != 'true' }} # Enable when ready
      shell: bash
      working-directory: ${{ steps.config.outputs.working_directory }}
      env:
        UV_PUBLISH_TOKEN: ${{ inputs.pypi_token }}
      run: |
        echo "Publishing to PyPI..."
        uv publish --publish-url https://upload.pypi.org/legacy/

    - name: Publish to TestPyPI
      if: ${{ inputs.dry_run != 'true' && steps.config.outputs.testpypi == 'true' }}
      shell: bash
      working-directory: ${{ steps.config.outputs.working_directory }}
      env:
        UV_PUBLISH_TOKEN: ${{ inputs.pypi_test_token }}
      run: |
        echo "Publishing to TestPyPI..."
        uv publish --publish-url https://test.pypi.org/legacy/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.run_id }}-${{ inputs.name }}
        path: ${{ steps.config.outputs.working_directory }}/dist/*.whl
        if-no-files-found: error
        retention-days: 90
