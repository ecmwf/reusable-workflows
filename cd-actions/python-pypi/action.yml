name: Python PyPI Publisher
description: Build and publish Python packages to PyPI/TestPyPI using UV

inputs:
  name:
    description: 'Build name for artifacts'
    required: true
  ref_name:
    description: 'Git ref name for release'
    required: true
  dry_run:
    description: 'Dry run mode - build only, no upload'
    required: false
    default: 'false'
  pypi_token:
    description: 'PyPI API token'
    required: false
  pypi_test_token:
    description: 'TestPyPI API token'
    required: false
  working_directory:
    description: 'Working directory for build (for monorepos)'
    required: false
    default: './'
  buildargs:
    description: 'Additional arguments for uv build command'
    required: false
    default: ''
  env_vars:
    description: 'Environment variables as JSON object (e.g., {"KEY": "value"})'
    required: false
    default: '{}'
  testpypi:
    description: 'Publish to TestPyPI instead of PyPI (overrides is_prerelease)'
    required: false
    default: 'false'

runs:
  using: composite
  steps:
    - name: Parse build configuration
      id: config
      shell: bash
      env:
        INPUT_WORKING_DIRECTORY: ${{ inputs.working_directory }}
        INPUT_BUILDARGS: ${{ inputs.buildargs }}
        INPUT_ENV_VARS: ${{ inputs.env_vars }}
        INPUT_TESTPYPI: ${{ inputs.testpypi }}
      run: python3 "${{ github.action_path }}/scripts/parse_config.py"

    - name: Set environment variables from config
      if: steps.config.outputs.env_vars != ''
      shell: bash
      working-directory: ${{ steps.config.outputs.working_directory }}
      run: |
        echo '${{ steps.config.outputs.env_vars }}' >> $GITHUB_ENV

    - name: Build package with uv
      shell: bash
      working-directory: ${{ steps.config.outputs.working_directory }}
      run: |
        echo "Building package with uv..."
        echo "Build args: ${{ steps.config.outputs.buildargs }}"
        uv build ${{ steps.config.outputs.buildargs }}
        echo ""
        echo "Built packages:"
        ls -lh dist/

    - name: Publish to PyPI
      if: ${{ false && inputs.dry_run != 'true' && steps.config.outputs.testpypi != 'true' }} # Enable when ready
      shell: bash
      working-directory: ${{ steps.config.outputs.working_directory }}
      env:
        UV_PUBLISH_TOKEN: ${{ inputs.pypi_token }}
      run: |
        echo "Publishing to PyPI..."
        uv publish --publish-url https://upload.pypi.org/legacy/

    - name: Publish to TestPyPI
      if: ${{ inputs.dry_run != 'true' && steps.config.outputs.testpypi == 'true' }}
      shell: bash
      working-directory: ${{ steps.config.outputs.working_directory }}
      env:
        UV_PUBLISH_TOKEN: ${{ inputs.pypi_test_token }}
      run: |
        echo "Publishing to TestPyPI..."
        uv publish --publish-url https://test.pypi.org/legacy/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.run_id }}-${{ inputs.name }}
        path: ${{ steps.config.outputs.working_directory }}/dist/*.whl
        if-no-files-found: error
        retention-days: 90
